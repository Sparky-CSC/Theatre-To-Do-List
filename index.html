<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Theatre To-Do List</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--primary-gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);--bg-light:#f8f9fa;--border-color:#e9ecef;--text-primary:#333;--text-secondary:#666}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--primary-gradient);min-height:100vh;padding:10px;transition:background .3s}
    body.dark-mode{--bg-light:#2d3436;--border-color:#4a4a4a;--text-primary:#f8f9fa;--text-secondary:#dfe6e9;background:linear-gradient(135deg,#2d3436 0%,#1e272e 100%)}
    body.dark-mode .container{background:#1e272e}
    body.dark-mode .todo-item{background:#2d3436;color:var(--text-primary)}
    body.dark-mode .modal-content{background:#2d3436;color:var(--text-primary)}
    body.dark-mode input,body.dark-mode textarea,body.dark-mode select{background:#1e272e;color:var(--text-primary);border-color:#4a4a4a}
    body.dark-mode .filter-section{background:#2d3436}
    body.dark-mode .comment{background:#1e272e}
    .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .header{background:var(--primary-gradient);color:#fff;padding:20px;text-align:center;position:relative;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .header-left{flex:1}
    .header h1{font-size:2em;margin-bottom:5px}
    .header p{font-size:.9em;opacity:.9}
    .header-right{display:flex;gap:10px;align-items:center}
    .dark-mode-toggle{background:rgba(255,255,255,.2);border:none;color:#fff;padding:8px 12px;border-radius:20px;cursor:pointer;font-size:1.2em;transition:background .3s}
    .dark-mode-toggle:hover{background:rgba(255,255,255,.3)}
    .user-info{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.2);padding:8px 12px;border-radius:25px;font-size:.85em}
    .user-avatar{width:32px;height:32px;border-radius:50%;border:2px solid #fff;object-fit:cover}
    .sign-out-btn{background:rgba(255,255,255,.3);color:#fff;border:none;padding:6px 12px;border-radius:15px;cursor:pointer;font-size:.85em;transition:background .3s}
    .sign-out-btn:hover{background:rgba(255,255,255,.4)}
    .login-screen{padding:60px 30px;text-align:center}
    .login-screen h2{color:var(--text-primary);margin-bottom:20px;font-size:2em}
    .login-screen p{color:var(--text-secondary);margin-bottom:30px;font-size:1.1em}
    .remember-me{display:flex;align-items:center;justify-content:center;gap:8px;margin:20px 0;font-size:.95em;color:var(--text-secondary)}
    .remember-me input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
    .remember-me label{cursor:pointer;user-select:none}
    .google-signin-btn{display:inline-flex;align-items:center;gap:12px;background:#fff;color:#444;border:2px solid #ddd;padding:12px 24px;border-radius:8px;font-size:1.1em;font-weight:600;cursor:pointer;transition:all .3s;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .google-signin-btn:hover{box-shadow:0 4px 12px rgba(0,0,0,.15);transform:translateY(-2px)}
    .google-icon{width:24px;height:24px}
    .action-bar{padding:20px;background:var(--bg-light);border-bottom:2px solid var(--border-color);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .export-buttons{display:flex;gap:10px;flex-wrap:wrap;transition:all .3s ease}
    .export-buttons.hidden{display:none}
    .toggle-section-btn{background:#6c757d;padding:8px 16px;font-size:.9em}
    .toggle-section-btn:hover{background:#5a6268}
    .search-box{flex:1;min-width:200px;padding:10px 15px;border:2px solid var(--border-color);border-radius:8px;font-size:.95em}
    .btn{background:var(--primary-gradient);color:#fff;border:none;padding:10px 20px;border-radius:8px;font-size:.95em;cursor:pointer;transition:all .2s;font-weight:600;display:inline-flex;align-items:center;gap:8px;white-space:nowrap}
    .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}
    .btn-success{background:linear-gradient(135deg,#4caf50 0%,#388e3c 100%)}
    .btn-danger{background:linear-gradient(135deg,#f44336 0%,#c62828 100%)}
    .btn-warning{background:linear-gradient(135deg,#ff9800 0%,#f57c00 100%)}
    .btn-info{background:linear-gradient(135deg,#2196f3 0%,#1976d2 100%)}
    .btn-small{padding:6px 12px;font-size:.85em}
    .filter-section{padding:15px 20px;background:#fff;border-bottom:1px solid var(--border-color);display:flex;gap:10px;flex-wrap:wrap;align-items:center;transition:all .3s ease;overflow:hidden;max-height:200px}
    .filter-section.collapsed{max-height:0;padding:0 20px;border-bottom:none}
    .filter-group{display:flex;align-items:center;gap:6px}
    .filter-group label{font-weight:600;color:var(--text-secondary);font-size:.9em}
    .filter-group select{padding:6px 10px;border:2px solid var(--border-color);border-radius:6px;font-size:.85em}
    .todo-list{padding:20px;max-height:600px;overflow-y:auto}
    .todo-item{background:var(--bg-light);border-left:4px solid #667eea;padding:15px;margin-bottom:12px;border-radius:8px;transition:all .3s;position:relative}
    .todo-item:hover{box-shadow:0 5px 15px rgba(0,0,0,.1);transform:translateX(5px)}
    .todo-item.priority-high{border-left-color:#f44336;background:linear-gradient(135deg,#ffebee 0%,#ffcdd2 100%)}
    .todo-item.priority-medium{border-left-color:#ff9800;background:linear-gradient(135deg,#fff3e0 0%,#ffe0b2 100%)}
    .todo-item.priority-low{border-left-color:#2196f3;background:linear-gradient(135deg,#e3f2fd 0%,#bbdefb 100%)}
    body.dark-mode .todo-item.priority-high{background:linear-gradient(135deg,#5d1f1f 0%,#7f2c2c 100%)}
    body.dark-mode .todo-item.priority-medium{background:linear-gradient(135deg,#5d4a1f 0%,#7f6419 100%)}
    body.dark-mode .todo-item.priority-low{background:linear-gradient(135deg,#1f3d5d 0%,#2c5f7f 100%)}
    .todo-item-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px}
    .todo-item-left{display:flex;align-items:flex-start;gap:12px;flex:1}
    .checkbox{width:22px;height:22px;cursor:pointer;accent-color:#667eea;flex-shrink:0;margin-top:2px}
    .todo-content{flex:1;min-width:0}
    .todo-title-row{display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap}
    .todo-title{font-size:1.05em;font-weight:600;color:var(--text-primary);word-break:break-word}
    .badge{padding:3px 10px;border-radius:12px;font-size:.7em;font-weight:bold;text-transform:uppercase;white-space:nowrap}
    .priority-badge.priority-high{background:#f44336;color:#fff}
    .priority-badge.priority-medium{background:#ff9800;color:#fff}
    .priority-badge.priority-low{background:#2196f3;color:#fff}
    .notification-badge{background:#9c27b0;color:#fff}
    .category-badge{background:#00bcd4;color:#fff}
    .overdue-badge{background:#f44336;color:#fff}
    .todo-description{color:var(--text-secondary);font-size:.85em;margin-bottom:8px;word-break:break-word}
    .todo-meta{display:flex;gap:12px;font-size:.8em;color:var(--text-secondary);flex-wrap:wrap;margin-bottom:8px}
    .meta-item{display:flex;align-items:center;gap:4px;white-space:nowrap}
    .todo-actions{display:flex;gap:6px;flex-wrap:wrap}
    .todo-item-right{display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap}
    .initials-input{width:90px;padding:6px;border:2px solid var(--border-color);border-radius:6px;text-align:center;text-transform:uppercase;font-weight:bold;font-size:.9em}
    .comments-section{margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color)}
    .comment{background:#fff;padding:10px;border-radius:6px;margin-bottom:8px;font-size:.85em}
    .comment-author{font-weight:600;color:#667eea;margin-bottom:4px}
    .comment-text{color:var(--text-secondary)}
    .comment-input-group{display:flex;gap:8px;margin-top:8px}
    .comment-input{flex:1;padding:8px;border:2px solid var(--border-color);border-radius:6px;font-size:.85em}
    .loading{text-align:center;padding:40px;color:var(--text-secondary);font-size:1.1em}
    .error{background:#ffebee;color:#c62828;padding:15px;border-radius:8px;margin:20px}
    .success{background:#e8f5e9;color:#2e7d32;padding:10px 15px;border-radius:6px;margin:10px 0;font-size:.9em;text-align:center}
    .stats{display:flex;gap:15px;padding:15px 20px;background:var(--primary-gradient);color:#fff}
    .stat-item{flex:1;text-align:center}
    .stat-number{font-size:1.8em;font-weight:bold}
    .stat-label{font-size:.85em;opacity:.9}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal-content{background:#fff;margin:2% auto;padding:0;border-radius:12px;width:90%;max-width:700px;max-height:90vh;overflow-y:auto;animation:slideIn .3s}
    @keyframes slideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-header{background:var(--primary-gradient);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .modal-header h2{margin:0;font-size:1.5em}
    .close{color:#fff;font-size:28px;font-weight:bold;cursor:pointer;line-height:1;transition:transform .2s}
    .close:hover{transform:scale(1.2)}
    .modal-body{padding:25px;max-height:calc(90vh - 180px);overflow-y:auto}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--text-primary)}
    .form-group input,.form-group textarea,.form-group select{width:100%;padding:10px;border:2px solid var(--border-color);border-radius:6px;font-size:1em;font-family:inherit;transition:border-color .3s}
    .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
    .form-group textarea{resize:vertical;min-height:80px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    .checkbox-group{display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg-light);border-radius:6px}
    .checkbox-group input[type="checkbox"]{width:20px;height:20px;cursor:pointer}
    .checkbox-group label{margin:0;cursor:pointer;font-weight:normal}
    .notification-info{background:#e3f2fd;padding:12px;border-radius:6px;margin-top:10px;font-size:.9em;color:#1976d2}
    body.dark-mode .notification-info{background:#1a237e;color:#90caf9}
    .email-input-group{display:none;margin-top:10px}
    .email-input-group.active{display:block}
    .email-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .email-tag{background:#667eea;color:#fff;padding:6px 12px;border-radius:20px;font-size:.85em;display:flex;align-items:center;gap:6px}
    .email-tag .remove{cursor:pointer;font-weight:bold}
    .file-upload-area{border:2px dashed var(--border-color);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:all .3s;background:var(--bg-light)}
    .file-upload-area:hover{border-color:#667eea}
    .file-upload-area.dragover{border-color:#667eea;background:#e3f2fd}
    .file-list{margin-top:10px}
    .file-item{display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--bg-light);border-radius:6px;margin-bottom:6px;font-size:.85em}
    .file-item-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .file-item-remove{cursor:pointer;color:#f44336;font-weight:bold;padding:0 8px}
    .modal-footer{padding:20px 25px;border-top:1px solid var(--border-color);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .btn-cancel{background:#6c757d}
    #mainContent{display:none}
    @media (max-width:768px){
      .header{flex-direction:column;gap:10px}
      .header h1{font-size:1.5em}
      .header-right{width:100%;justify-content:center}
      .action-bar{flex-direction:column;align-items:stretch}
      .search-box{width:100%}
      .btn{width:100%;justify-content:center}
      .filter-section{flex-direction:column;align-items:stretch}
      .filter-group{flex-direction:column;align-items:stretch}
      .filter-group select{width:100%}
      .stats{flex-direction:column;gap:10px}
      .todo-item-header{flex-direction:column}
      .todo-item-right{width:100%;justify-content:flex-start}
      .form-row{grid-template-columns:1fr}
      .modal-content{width:95%;margin:10px auto}
      .modal-footer{flex-direction:column}
      .modal-footer .btn{width:100%}
    }
    @media (max-width:480px){
      body{padding:5px}
      .container{border-radius:10px}
      .header{padding:15px}
      .action-bar,.filter-section,.todo-list{padding:15px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1>üé≠ Theatre To-Do List</h1>
        <p>Connected to Google Sheets</p>
      </div>
      <div class="header-right">
        <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">üåô</button>
        <div class="user-info" id="userInfo" style="display:none;">
          <img id="userAvatar" class="user-avatar" alt="User"/>
          <span id="userName"></span>
          <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
        </div>
      </div>
    </div>

    <div class="login-screen" id="loginScreen">
      <h2>Welcome to Theatre To-Do List</h2>
      <p>Sign in with Google to view and manage your team's tasks</p>
      <button class="google-signin-btn" onclick="handleSignIn()">
        <svg class="google-icon" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Sign in with Google
      </button>
      <div class="remember-me">
        <input type="checkbox" id="rememberMe" checked />
        <label for="rememberMe">Remember me on this device</label>
      </div>
    </div>

    <div id="mainContent">
      <div class="stats" id="stats">
        <div class="stat-item"><div class="stat-number" id="totalTasks">0</div><div class="stat-label">Total Tasks</div></div>
        <div class="stat-item"><div class="stat-number" id="completedTasks">0</div><div class="stat-label">Completed</div></div>
        <div class="stat-item"><div class="stat-number" id="pendingTasks">0</div><div class="stat-label">Pending</div></div>
      </div>

      <div class="action-bar">
        <input type="text" class="search-box" id="searchBox" placeholder="üîç Search tasks..." oninput="applyFilters()"/>
        <button class="btn btn-success" onclick="openTaskModal()" id="createBtn" style="display:none;">‚ûï Create Task</button>
        <button class="btn toggle-section-btn" onclick="toggleExports()"><span id="exportToggleIcon">üì§</span> Exports</button>
        <button class="btn toggle-section-btn" onclick="toggleFilters()"><span id="filterToggleIcon">üîΩ</span> Filters</button>
        <div class="export-buttons" id="exportButtons">
          <button class="btn btn-info" onclick="exportToPDF()">üìÑ PDF</button>
          <button class="btn btn-warning" onclick="exportToExcel()">üìä Excel</button>
        </div>
        <button class="btn" onclick="loadTasks()">‚Üª Refresh</button>
      </div>

      <div class="filter-section" id="filterSection">
        <div class="filter-group">
          <label for="priorityFilter">Priority:</label>
          <select id="priorityFilter" onchange="applyFilters()">
            <option value="all">All</option><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="categoryFilter">Category:</label>
          <select id="categoryFilter" onchange="applyFilters()"><option value="all">All</option></select>
        </div>
        <div class="filter-group">
          <label for="creatorFilter">Created By:</label>
          <select id="creatorFilter" onchange="applyFilters()"><option value="all">All</option></select>
        </div>
        <div class="filter-group">
          <label for="assignedFilter">Assigned To:</label>
          <select id="assignedFilter" onchange="applyFilters()"><option value="all">All</option></select>
        </div>
        <div class="filter-group">
          <label for="dueDateFilter">Due Date:</label>
          <select id="dueDateFilter" onchange="applyFilters()">
            <option value="all">All</option><option value="overdue">Overdue</option><option value="today">Today</option>
            <option value="week">This Week</option><option value="month">This Month</option>
          </select>
        </div>
      </div>

      <div class="todo-list" id="todoList">
        <div class="loading">Loading tasks from Google Sheets...</div>
      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Create New Task</h2>
        <span class="close" onclick="closeTaskModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="taskForm" onsubmit="saveTask(event)">
          <input type="hidden" id="editTaskId" />
          <div class="form-group">
            <label for="taskTitle">Task Title *</label>
            <input type="text" id="taskTitle" required placeholder="Enter task title"/>
          </div>
          <div class="form-group">
            <label for="taskDescription">Description</label>
            <textarea id="taskDescription" placeholder="Enter task description"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="taskPriority">Priority *</label>
              <select id="taskPriority" required>
                <option value="Medium">Medium</option><option value="High">High</option><option value="Low">Low</option>
              </select>
            </div>
            <div class="form-group">
              <label for="taskCategorySelect">Category</label>
              <!-- Populated from Sheets (unique categories in data) -->
              <select id="taskCategorySelect">
                <option value="">(none)</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="taskDueDate">Due Date</label>
              <input type="date" id="taskDueDate"/>
            </div>
            <div class="form-group">
              <label for="taskDueTime">Due Time (optional)</label>
              <input type="time" id="taskDueTime" />
            </div>
          </div>

          <div class="form-group">
            <label for="taskAssignedToSelect">Assign To</label>
            <!-- Populated from Sheets (unique assignees in data) -->
            <select id="taskAssignedToSelect">
              <option value="">(unassigned)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Email Notifications</label>
            <div class="checkbox-group">
              <input type="checkbox" id="enableNotifications" onchange="toggleEmailInput()"/>
              <label for="enableNotifications">Send email when task is completed</label>
            </div>
            <div id="emailInputGroup" class="email-input-group">
              <label for="notificationEmails">Email Addresses (press Enter to add)</label>
              <input type="email" id="notificationEmails" placeholder="Enter email and press Enter"/>
              <div id="emailTags" class="email-tags"></div>
              <div class="notification-info">üí° Email notifications will be sent when this task is marked complete.</div>
            </div>
          </div>

          <div class="form-group">
            <label for="taskFiles">Attachments</label>
            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
              <p>üìé Click to upload files or drag and drop</p>
              <p style="font-size:.85em;color:var(--text-secondary);">Max 5MB per file</p>
            </div>
            <input type="file" id="fileInput" multiple style="display:none" onchange="handleFileSelect(event)"/>
            <div id="fileList" class="file-list"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeTaskModal()">Cancel</button>
        <button class="btn btn-success" onclick="document.getElementById('taskForm').requestSubmit()">Save Task</button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- App script with Remember Me + One Tap + dropdowns + time -->
  <script>
/* ============================
   Stable Remember Me + One Tap (first-time only)
   - Dropdowns for Category and Assign To (from Sheet data)
   - Optional Due Time saved as ISO (YYYY-MM-DDTHH:MM)
   - Robust userinfo (no "undefined")
   ============================ */

const CLIENT_ID = '429266563329-677t97fuhed0v47p5odrfog71qhcqdh6.apps.googleusercontent.com';
const API_KEY   = 'AIzaSyBgaa8xdZdWErS2zm0g-P15Gu-F-XBLc8A';
const SHEET_ID  = '1z2Pw0ZwDMYpD7-NbaM_HMPqaE62Lyla1nAstbUziJLY';
const SCOPES    = [
  'https://www.googleapis.com/auth/spreadsheets',
  'https://www.googleapis.com/auth/userinfo.email',
  'https://www.googleapis.com/auth/userinfo.profile',
  'openid'
].join(' ');

const ADMIN_EMAILS = ['myork@culver.edu','hheaton@culver.edu','dlane@culver.edu'];

let tokenClient;
let accessToken = null;
let currentUser = null;
let isAdmin = false;
let gapiReady = false;
let gisReady = false;
let oneTapReady = false;
let refreshTimer = null;

// app state
let tasks = [];
let allTasks = [];
let notificationEmails = [];
let uploadedFiles = [];
let editingTaskId = null;
let taskComments = {};

// ---------- Utility ----------
function isSecureContextForOneTap(){
  return location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
}
function parseJwt(token){
  try{
    const base64Url = token.split('.')[1]; if(!base64Url) return {};
    const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(jsonPayload||'{}');
  }catch(e){ return {}; }
}
// parse due date string that may contain time
function parseDue(dueStr){
  if(!dueStr) return null;
  // Accept 'YYYY-MM-DD' or 'YYYY-MM-DDTHH:MM'
  const iso = dueStr.includes('T') ? dueStr : dueStr; // both fine
  const d = new Date(iso);
  return isNaN(d.getTime()) ? null : d;
}
function formatDueDisplay(dueStr){
  if(!dueStr) return '';
  const d = parseDue(dueStr);
  if(!d) return dueStr;
  const hasTime = dueStr.includes('T');
  return hasTime ? d.toLocaleString() : d.toLocaleDateString();
}

// ---------- Loaders ----------
function gapiLoaded(){ gapi.load('client', initializeGapiClient); }
async function initializeGapiClient(){
  await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
  gapiReady = true;
  tryStartAuthFlow();
}
function gisLoaded(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: onTokenResponse
  });
  gisReady = true;
  tryStartAuthFlow();
}
function gsiIdLoaded(){ oneTapReady = true; tryStartAuthFlow(); }

// ---------- Bootstrap auth decision ----------
function tryStartAuthFlow(){
  if(!gapiReady || !gisReady || !oneTapReady) return;

  const remembered = localStorage.getItem('rememberMe') === 'true';
  const loginHint = localStorage.getItem('loginHint') || '';

  if(remembered){
    tokenClient.requestAccessToken({ prompt: '', login_hint: loginHint || undefined });
    return;
  }

  const oneTapShown = sessionStorage.getItem('oneTapShown') === 'true';
  if(!oneTapShown && isSecureContextForOneTap()){
    initAndPromptOneTap();
  }
}

// ---------- One Tap (first-time) ----------
function initAndPromptOneTap(){
  sessionStorage.setItem('oneTapShown','true');

  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleOneTapCredential,
    auto_select: false,
    cancel_on_tap_outside: true,
    context: 'signin'
  });

  google.accounts.id.prompt(() => {});
}

function handleOneTapCredential(response){
  const payload = parseJwt(response.credential || '');
  const email   = (payload && payload.email) ? String(payload.email).toLowerCase() : '';
  const name    = payload.name || payload.given_name || '';
  const picture = payload.picture || '';

  // show provisional UI
  setHeaderUserUI({ name, email, picture });

  if(email){ localStorage.setItem('loginHint', email); }
  tokenClient.requestAccessToken({ prompt: '', login_hint: email || undefined });
}

// ---------- OAuth flow ----------
function onTokenResponse(rsp){
  if(rsp && rsp.error){
    showLogin();
    return;
  }
  accessToken = rsp.access_token;
  scheduleTokenRefresh(45*60*1000);
  onSignInSuccess();
}

function scheduleTokenRefresh(ms){
  clearTimeout(refreshTimer);
  const remembered = localStorage.getItem('rememberMe') === 'true';
  if(!remembered) return;
  const hint = localStorage.getItem('loginHint') || '';
  refreshTimer = setTimeout(() => {
    tokenClient.requestAccessToken({ prompt: '', login_hint: hint || undefined });
  }, ms);
}

function handleSignIn(){
  const rememberChecked = document.getElementById('rememberMe')?.checked !== false;
  if(rememberChecked){
    localStorage.setItem('rememberMe','true');
  }else{
    localStorage.removeItem('rememberMe');
    localStorage.removeItem('loginHint');
  }
  tokenClient.requestAccessToken({ prompt: 'consent' });
}

function onSignInSuccess(){
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainContent').style.display = 'block';

  fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { Authorization: `Bearer ${accessToken}` }})
    .then(r=>r.json())
    .then(data=>{
      const displayName = data.name || data.given_name || (data.email ? data.email.split('@')[0] : 'User');
      const picture = data.picture || '';
      currentUser = { ...data, name: displayName, picture };

      if(localStorage.getItem('rememberMe') === 'true' && data?.email){
        localStorage.setItem('loginHint', data.email.toLowerCase());
      }
      isAdmin = !!data?.email && ADMIN_EMAILS.includes(data.email.toLowerCase());

      setHeaderUserUI({ name: displayName, email: data.email, picture, isAdmin });
      loadToggleStates();
      loadTasks();
    })
    .catch(err=>{
      console.error('userinfo error:', err);
      showLogin();
    });
}

function setHeaderUserUI({ name='', email='', picture='', isAdmin=false }={}){
  const nameEl = document.getElementById('userName');
  const avatar = document.getElementById('userAvatar');
  const display = name || (email ? email.split('@')[0] : 'User');
  nameEl.textContent = display + (isAdmin ? ' (Admin)' : '');
  if(picture){
    avatar.src = picture;
    avatar.style.display = 'block';
  }else{
    avatar.style.display = 'none';
  }
  document.getElementById('userInfo').style.display = 'flex';
}

function signOut(){
  localStorage.removeItem('rememberMe');
  localStorage.removeItem('loginHint');
  clearTimeout(refreshTimer);

  try{ google.accounts.id.disableAutoSelect(); }catch(e){}
  if(accessToken){
    google.accounts.oauth2.revoke(accessToken, ()=>{
      accessToken = null; currentUser=null; isAdmin=false; showLogin();
    });
  }else{
    showLogin();
  }
}

function showLogin(){
  accessToken = null; currentUser=null; isAdmin=false; clearTimeout(refreshTimer);
  document.getElementById('loginScreen').style.display = 'block';
  document.getElementById('mainContent').style.display = 'none';
  document.getElementById('userInfo').style.display = 'none';
}

// ---------- Sheets + UI ----------
async function loadTasks(){
  if(!accessToken) return;
  const todoList = document.getElementById('todoList');
  todoList.innerHTML = '<div class="loading">Loading tasks...</div>';
  try{
    const response = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID, range: 'Sheet1!A2:M'
    });
    const rows = response.result.values || [];
    allTasks = rows.map((row,idx)=>({
      id: idx+2,
      task: row[0]||'',
      description: row[1]||'',
      priority: row[2]||'Medium',
      createdBy: row[3]||'',
      completed: row[4]==='TRUE',
      completedBy: row[5]||'',
      dateCompleted: row[6]||'',
      notify: row[7]==='TRUE',
      notificationEmails: row[8]||'',
      category: row[9]||'',
      dueDate: row[10]||'',
      assignedTo: row[11]||'',
      comments: row[12]||''
    })).filter(t=>!t.completed);

    // sort by priority then due date/time
    const order = {High:1, Medium:2, Low:3};
    allTasks.sort((a,b)=>{
      const p = (order[a.priority]||99)-(order[b.priority]||99);
      if(p!==0) return p;
      const da = parseDue(a.dueDate); const db = parseDue(b.dueDate);
      if(da && db) return da - db;
      if(da) return -1;
      if(db) return 1;
      return 0;
    });

    tasks=[...allTasks];

    // Populate filters and form dropdowns from live data
    populateFilters();
    populateFormLists();

    renderTasks();
    updateStats();
  }catch(err){
    todoList.innerHTML = `<div class="error">Error loading tasks: ${err.message}</div>`;
  }
}

function uniqueNonEmpty(list){ return [...new Set(list.filter(Boolean))]; }

function populateFilters(){
  const creators=uniqueNonEmpty(allTasks.map(t=>t.createdBy));
  const categories=uniqueNonEmpty(allTasks.map(t=>t.category));
  const assignees=uniqueNonEmpty(allTasks.map(t=>t.assignedTo));
  const creatorSelect=document.getElementById('creatorFilter');
  const categorySelect=document.getElementById('categoryFilter');
  const assignedSelect=document.getElementById('assignedFilter');
  creatorSelect.innerHTML='<option value="all">All</option>'+creators.map(c=>`<option value="${c}">${c}</option>`).join('');
  categorySelect.innerHTML='<option value="all">All</option>'+categories.map(c=>`<option value="${c}">${c}</option>`).join('');
  assignedSelect.innerHTML='<option value="all">All</option>'+assignees.map(a=>`<option value="${a}">${a}</option>`).join('');
}

// NEW: Populate Category/AssignTo dropdowns in the Task Modal from Sheet data
function populateFormLists(selected = {}){
  const categories=uniqueNonEmpty(allTasks.map(t=>t.category));
  const assignees=uniqueNonEmpty(allTasks.map(t=>t.assignedTo));
  const catSel = document.getElementById('taskCategorySelect');
  const asgSel = document.getElementById('taskAssignedToSelect');

  catSel.innerHTML = '<option value="">(none)</option>' + categories.map(c=>`<option value="${c}">${c}</option>`).join('');
  asgSel.innerHTML = '<option value="">(unassigned)</option>' + assignees.map(a=>`<option value="${a}">${a}</option>`).join('');

  if(selected.category) catSel.value = selected.category;
  if(selected.assignedTo) asgSel.value = selected.assignedTo;
}

function applyFilters(){
  const searchTerm=(document.getElementById('searchBox').value||'').toLowerCase();
  const pf=document.getElementById('priorityFilter').value;
  const cf=document.getElementById('categoryFilter').value;
  const crf=document.getElementById('creatorFilter').value;
  const af=document.getElementById('assignedFilter').value;
  const df=document.getElementById('dueDateFilter').value;

  tasks = allTasks.filter(t=>{
    if(searchTerm && !t.task.toLowerCase().includes(searchTerm) && !t.description.toLowerCase().includes(searchTerm)) return false;
    if(pf!=='all' && t.priority!==pf) return false;
    if(cf!=='all' && t.category!==cf) return false;
    if(crf!=='all' && t.createdBy!==crf) return false;
    if(af!=='all' && t.assignedTo!==af) return false;
    if(df!=='all' && t.dueDate){
      const due=parseDue(t.dueDate); if(!due) return false;
      const today=new Date(); today.setHours(0,0,0,0);
      if(df==='overdue' && due >= today) return false;
      if(df==='today'){
        const todayEnd = new Date(today); todayEnd.setDate(todayEnd.getDate()+1);
        if(!(due >= today && due < todayEnd)) return false;
      }
      if(df==='week'){
        const weekFromNow=new Date(today); weekFromNow.setDate(weekFromNow.getDate()+7);
        if(due < today || due > weekFromNow) return false;
      }
      if(df==='month'){
        const monthFromNow=new Date(today); monthFromNow.setMonth(monthFromNow.getMonth()+1);
        if(due < today || due > monthFromNow) return false;
      }
    }
    return true;
  });

  const order={High:1, Medium:2, Low:3};
  tasks.sort((a,b)=>{
    const p=(order[a.priority]||99)-(order[b.priority]||99);
    if(p!==0) return p;
    const da=parseDue(a.dueDate), db=parseDue(b.dueDate);
    if(da && db) return da - db;
    if(da) return -1;
    if(db) return 1;
    return 0;
  });

  renderTasks();
}

function updateStats(){
  gapi.client.sheets.spreadsheets.values.get({ spreadsheetId:SHEET_ID, range:'Sheet1!E2:E' })
    .then(res=>{
      const col=res.result.values||[];
      const completed=col.filter(r=>r[0]==='TRUE').length;
      document.getElementById('totalTasks').textContent = allTasks.length + completed;
      document.getElementById('completedTasks').textContent = completed;
      document.getElementById('pendingTasks').textContent = allTasks.length;
    });
}

function isOverdue(dueStr){
  const d = parseDue(dueStr);
  if(!d) return false;
  const now = new Date();
  return d < now.setHours(0,0,0,0); // overdue if strictly before today
}

function renderTasks(){
  const list=document.getElementById('todoList');
  if(tasks.length===0){ list.innerHTML='<div class="loading">No pending tasks found. Great job! üéâ</div>'; return; }
  list.innerHTML = tasks.map(t=>{
    const comments = t.comments ? JSON.parse(t.comments) : [];
    const overdue = isOverdue(t.dueDate);
    const dueDisp = t.dueDate ? formatDueDisplay(t.dueDate) : '';
    return `
      <div class="todo-item priority-${t.priority.toLowerCase()}" data-id="${t.id}">
        <div class="todo-item-header">
          <div class="todo-item-left">
            <input type="checkbox" class="checkbox" onchange="toggleTask(${t.id})">
            <div class="todo-content">
              <div class="todo-title-row">
                <div class="todo-title">${t.task}</div>
                <span class="badge priority-badge priority-${t.priority.toLowerCase()}">${t.priority}</span>
                ${t.category ? `<span class="badge category-badge">${t.category}</span>`:''}
                ${t.notify ? '<span class="badge notification-badge">üîî Notify</span>':''}
                ${overdue ? '<span class="badge overdue-badge">‚ö†Ô∏è Overdue</span>':''}
              </div>
              ${t.description ? `<div class="todo-description">${t.description}</div>`:''}
              <div class="todo-meta">
                <div class="meta-item">üë§ Created by: <strong>${t.createdBy}</strong></div>
                ${t.assignedTo ? `<div class="meta-item">üë• Assigned to: <strong>${t.assignedTo}</strong></div>`:''}
                ${dueDisp ? `<div class="meta-item">üìÖ Due: <strong>${dueDisp}</strong></div>`:''}
                ${comments.length>0 ? `<div class="meta-item">üí¨ ${comments.length} comment(s)</div>`:''}
              </div>
              <div class="todo-actions">
                ${isAdmin ? `
                  <button class="btn btn-small btn-info" onclick="openEditTask(${t.id})">‚úèÔ∏è Edit</button>
                  <button class="btn btn-small btn-danger" onclick="deleteTask(${t.id})">üóëÔ∏è Delete</button>` : ''
                }
                <button class="btn btn-small" onclick="toggleComments(${t.id})">üí¨ Comments</button>
              </div>
              <div class="comments-section" id="comments-${t.id}" style="display:none;">
                ${comments.map(c=>`
                  <div class="comment">
                    <div class="comment-author">${c.author}</div>
                    <div class="comment-text">${c.text}</div>
                  </div>`).join('')}
                <div class="comment-input-group">
                  <input type="text" class="comment-input" id="comment-input-${t.id}" placeholder="Add a comment...">
                  <button class="btn btn-small btn-success" onclick="addComment(${t.id})">Send</button>
                </div>
              </div>
            </div>
          </div>
          <div class="todo-item-right">
            <input type="text" class="initials-input" placeholder="Initials" maxlength="5" id="initials-${t.id}">
          </div>
        </div>
      </div>`;
  }).join('');
}

async function toggleTask(taskId){
  const initialsInput=document.getElementById(`initials-${taskId}`);
  const initials=initialsInput?.value.trim().toUpperCase();
  if(!initials){
    alert('Please enter your initials before marking the task as complete!');
    const cb=document.querySelector(`[data-id="${taskId}"] .checkbox`); if(cb) cb.checked=false;
    return;
  }
  const today=new Date().toISOString().split('T')[0];
  const task=allTasks.find(t=>t.id===taskId);
  try{
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId:SHEET_ID, range:`Sheet1!E${taskId}:G${taskId}`, valueInputOption:'RAW',
      resource:{ values:[['TRUE', initials, today]] }
    });
    if(task && task.notify && task.notificationEmails) sendNotification(task, initials, today);
    const idx=allTasks.findIndex(t=>t.id===taskId); if(idx!==-1) allTasks.splice(idx,1);
    const item=document.querySelector(`[data-id="${taskId}"]`);
    item.style.background='#4caf50'; item.style.color='#fff';
    const msg=document.createElement('div'); msg.className='success'; msg.textContent='‚úÖ Task completed! Removed from list.'+(task && task.notify ? ' üìß Notifications sent!':'');
    item.parentElement.insertBefore(msg,item);
    setTimeout(()=>{ msg.remove(); item.remove(); updateStats(); applyFilters(); },1500);
  }catch(e){
    alert('Error updating task: '+e.message);
    const cb=document.querySelector(`[data-id="${taskId}"] .checkbox`); if(cb) cb.checked=false;
  }
}
function sendNotification(task,completedBy,dateCompleted){
  const emails=task.notificationEmails.split(',').map(e=>e.trim());
  console.log('üìß Notify:', emails, {task:task.task,completedBy,dateCompleted});
}

// ----- Modal / save / delete / comments -----
function openTaskModal(){
  if(!isAdmin) return alert('Only administrators can create tasks.');
  editingTaskId=null; document.getElementById('modalTitle').textContent='Create New Task';
  document.getElementById('taskForm').reset();
  // ensure dropdowns reflect latest data
  populateFormLists();
  notificationEmails=[]; uploadedFiles=[];
  document.getElementById('emailTags').innerHTML=''; document.getElementById('fileList').innerHTML='';
  document.getElementById('emailInputGroup').classList.remove('active');
  document.getElementById('taskModal').style.display='block';
}

function openEditTask(taskId){
  if(!isAdmin) return alert('Only administrators can edit tasks.');
  const t=allTasks.find(x=>x.id===taskId); if(!t) return;

  editingTaskId=taskId;
  document.getElementById('modalTitle').textContent='Edit Task';
  document.getElementById('taskTitle').value=t.task;
  document.getElementById('taskDescription').value=t.description;
  document.getElementById('taskPriority').value=t.priority;

  // prepare dropdowns with current selections
  populateFormLists({ category: t.category || '', assignedTo: t.assignedTo || '' });

  // due date + optional time
  if(t.dueDate){
    const hasTime = t.dueDate.includes('T');
    if(hasTime){
      const [d, tm] = t.dueDate.split('T');
      document.getElementById('taskDueDate').value = d;
      document.getElementById('taskDueTime').value = tm.slice(0,5);
    }else{
      document.getElementById('taskDueDate').value = t.dueDate;
      document.getElementById('taskDueTime').value = '';
    }
  }else{
    document.getElementById('taskDueDate').value = '';
    document.getElementById('taskDueTime').value = '';
  }

  document.getElementById('enableNotifications').checked=t.notify;
  if(t.notify && t.notificationEmails){
    notificationEmails=t.notificationEmails.split(',').map(e=>e.trim());
    document.getElementById('emailInputGroup').classList.add('active'); renderEmailTags();
  }
  document.getElementById('taskModal').style.display='block';
}

function closeTaskModal(){
  document.getElementById('taskModal').style.display='none';
  document.getElementById('taskForm').reset();
  notificationEmails=[]; uploadedFiles=[]; editingTaskId=null;
}

async function saveTask(e){
  e.preventDefault();
  if(!isAdmin) return alert('Only administrators can save tasks.');

  const title=document.getElementById('taskTitle').value.trim();
  const description=document.getElementById('taskDescription').value.trim();
  const priority=document.getElementById('taskPriority').value;
  const category=document.getElementById('taskCategorySelect').value.trim();
  const dueDate=document.getElementById('taskDueDate').value;
  const dueTime=document.getElementById('taskDueTime').value;
  const assignedTo=document.getElementById('taskAssignedToSelect').value.trim();
  const notify=document.getElementById('enableNotifications').checked;
  const emails=notificationEmails.join(',');

  if(!title) return alert('Please enter a task title!');

  // combine date + time to ISO if time is given (store in the Due Date column)
  const dueValue = dueDate ? (dueTime ? `${dueDate}T${dueTime}` : dueDate) : '';

  try{
    if(editingTaskId){
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId:SHEET_ID, range:`Sheet1!A${editingTaskId}:M${editingTaskId}`, valueInputOption:'RAW',
        resource:{ values:[[title,description,priority,currentUser.name,'FALSE','','',notify?'TRUE':'FALSE',emails,category,dueValue,assignedTo,taskComments[editingTaskId] || '']] }
      });
    }else{
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId:SHEET_ID, range:'Sheet1!A:M', valueInputOption:'RAW',
        resource:{ values:[[title,description,priority,currentUser.name,'FALSE','','',notify?'TRUE':'FALSE',emails,category,dueValue,assignedTo,'']] }
      });
    }
    const list=document.getElementById('todoList');
    const msg=document.createElement('div'); msg.className='success'; msg.textContent=editingTaskId?'‚úÖ Task updated successfully!':'‚úÖ Task created successfully!';
    list.insertBefore(msg,list.firstChild); setTimeout(()=>msg.remove(),2000);

    closeTaskModal(); loadTasks();
  }catch(err){ alert('Error saving task: '+err.message); }
}

async function deleteTask(taskId){
  if(!isAdmin) return alert('Only administrators can delete tasks.');
  if(!confirm('Are you sure you want to delete this task?')) return;
  try{
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId:SHEET_ID, range:`Sheet1!A${taskId}:M${taskId}`, valueInputOption:'RAW',
      resource:{ values:[['','','','','','','','','','','','','']] }
    });
    const list=document.getElementById('todoList'); const msg=document.createElement('div');
    msg.className='success'; msg.textContent='‚úÖ Task deleted successfully!'; list.insertBefore(msg,list.firstChild);
    setTimeout(()=>msg.remove(),2000); loadTasks();
  }catch(err){ alert('Error deleting task: '+err.message); }
}

function toggleComments(taskId){
  const el=document.getElementById(`comments-${taskId}`);
  el.style.display = el.style.display==='none' ? 'block' : 'none';
}

async function addComment(taskId){
  const input=document.getElementById(`comment-input-${taskId}`); const text=input.value.trim(); if(!text) return;
  const t=allTasks.find(x=>x.id===taskId); if(!t) return;
  const comments=t.comments?JSON.parse(t.comments):[]; comments.push({author:currentUser.name,text,date:new Date().toISOString()});
  try{
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId:SHEET_ID, range:`Sheet1!M${taskId}`, valueInputOption:'RAW',
      resource:{ values:[[JSON.stringify(comments)]] }
    });
    input.value=''; loadTasks();
  }catch(err){ alert('Error adding comment: '+err.message); }
}

// Email tags
function toggleEmailInput(){
  const cb=document.getElementById('enableNotifications'); const group=document.getElementById('emailInputGroup');
  if(cb.checked){ group.classList.add('active'); } else { group.classList.remove('active'); notificationEmails=[]; document.getElementById('emailTags').innerHTML=''; }
}
document.addEventListener('DOMContentLoaded', ()=>{
  const emailInput=document.getElementById('notificationEmails');
  if(emailInput){ emailInput.addEventListener('keypress',e=>{ if(e.key==='Enter'){ e.preventDefault(); addEmailTag(); } }); }
});
function addEmailTag(){
  const input=document.getElementById('notificationEmails'); const email=input.value.trim();
  if(email && validateEmail(email) && !notificationEmails.includes(email)){ notificationEmails.push(email); renderEmailTags(); input.value=''; }
  else if(notificationEmails.includes(email)){ alert('This email is already added!'); }
  else if(email){ alert('Please enter a valid email address!'); }
}
function validateEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
function renderEmailTags(){
  const c=document.getElementById('emailTags');
  c.innerHTML = notificationEmails.map((e,i)=>`<div class="email-tag">${e}<span class="remove" onclick="removeEmailTag(${i})">√ó</span></div>`).join('');
}
function removeEmailTag(i){ notificationEmails.splice(i,1); renderEmailTags(); }

// Files
function handleFileSelect(ev){
  const files=Array.from(ev.target.files);
  files.forEach(f=>{ if(f.size>5*1024*1024){ alert(`${f.name} is too large. Max size is 5MB.`); return; } uploadedFiles.push(f); });
  renderFileList();
}
function renderFileList(){
  const c=document.getElementById('fileList');
  c.innerHTML = uploadedFiles.map((f,i)=>`
    <div class="file-item"><span class="file-item-name">üìé ${f.name}</span><span class="file-item-remove" onclick="removeFile(${i})">√ó</span></div>
  `).join('');
}
function removeFile(i){ uploadedFiles.splice(i,1); renderFileList(); }

// DnD
const fileUploadArea=document.getElementById('fileUploadArea');
if(fileUploadArea){
  fileUploadArea.addEventListener('dragover',e=>{ e.preventDefault(); fileUploadArea.classList.add('dragover'); });
  fileUploadArea.addEventListener('dragleave',()=> fileUploadArea.classList.remove('dragover'));
  fileUploadArea.addEventListener('drop',e=>{
    e.preventDefault(); fileUploadArea.classList.remove('dragover');
    const files=Array.from(e.dataTransfer.files);
    files.forEach(f=>{ if(f.size<=5*1024*1024) uploadedFiles.push(f); });
    renderFileList();
  });
}

// Dark mode
function toggleDarkMode(){
  document.body.classList.toggle('dark-mode');
  const isDark=document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode',isDark);
  document.querySelector('.dark-mode-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
}
if(localStorage.getItem('darkMode')==='true'){
  document.body.classList.add('dark-mode');
  document.querySelector('.dark-mode-toggle').textContent='‚òÄÔ∏è';
}

// Exports
function exportToPDF(){
  const { jsPDF } = window.jspdf; const doc=new jsPDF();
  doc.setFontSize(18); doc.text('Theatre To-Do List',14,20);
  doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleDateString()}`,14,28);
  doc.text(`Total Tasks: ${tasks.length}`,14,34);
  const tableData=tasks.map(t=>[
    t.task,
    t.priority,
    t.category||'N/A',
    t.assignedTo||'Unassigned',
    t.dueDate ? formatDueDisplay(t.dueDate) : 'No due date',
    t.createdBy
  ]);
  doc.autoTable({ head:[['Task','Priority','Category','Assigned To','Due Date','Created By']], body:tableData, startY:40, styles:{fontSize:8}, headStyles:{fillColor:[102,126,234]}});
  doc.save('theatre-todo-list.pdf');
}
function exportToExcel(){
  const data=tasks.map(t=>({
    'Task':t.task,
    'Description':t.description,
    'Priority':t.priority,
    'Category':t.category||'',
    'Created By':t.createdBy,
    'Assigned To':t.assignedTo||'',
    'Due Date':t.dueDate ? formatDueDisplay(t.dueDate) : '',
    'Notify':t.notify?'Yes':'No'
  }));
  const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Tasks'); XLSX.writeFile(wb,'theatre-todo-list.xlsx');
}

// UI toggles
function toggleExports(){
  const el=document.getElementById('exportButtons'); const icon=document.getElementById('exportToggleIcon');
  if(el.classList.contains('hidden')){ el.classList.remove('hidden'); icon.textContent='üì§'; localStorage.setItem('exportsVisible','true'); }
  else{ el.classList.add('hidden'); icon.textContent='üì•'; localStorage.setItem('exportsVisible','false'); }
}
function toggleFilters(){
  const el=document.getElementById('filterSection'); const icon=document.getElementById('filterToggleIcon');
  if(el.classList.contains('collapsed')){ el.classList.remove('collapsed'); icon.textContent='üîΩ'; localStorage.setItem('filtersVisible','true'); }
  else{ el.classList.add('collapsed'); icon.textContent='‚ñ∂Ô∏è'; localStorage.setItem('filtersVisible','false'); }
}
function loadToggleStates(){
  const ev=localStorage.getItem('exportsVisible'); const fv=localStorage.getItem('filtersVisible');
  if(ev==='false'){ document.getElementById('exportButtons').classList.add('hidden'); document.getElementById('exportToggleIcon').textContent='üì•'; }
  if(fv==='false'){ document.getElementById('filterSection').classList.add('collapsed'); document.getElementById('filterToggleIcon').textContent='‚ñ∂Ô∏è'; }
}

// close modal on outside click
window.onclick=function(e){ const m=document.getElementById('taskModal'); if(e.target===m) closeTaskModal(); }

// expose handlers
window.gapiLoaded=gapiLoaded;
window.gisLoaded=gisLoaded;
window.gsiIdLoaded=gsiIdLoaded;
window.handleSignIn=handleSignIn;
window.signOut=signOut;
window.toggleDarkMode=toggleDarkMode;
window.openTaskModal=openTaskModal;
window.openEditTask=openEditTask;
window.closeTaskModal=closeTaskModal;
window.saveTask=saveTask;
window.deleteTask=deleteTask;
window.applyFilters=applyFilters;
window.loadTasks=loadTasks;
window.toggleComments=toggleComments;
window.addComment=addComment;
window.exportToPDF=exportToPDF;
window.exportToExcel=exportToExcel;
window.toggleExports=toggleExports;
window.toggleFilters=toggleFilters;

// auto-refresh tasks (if signed in)
setInterval(()=>{ if(accessToken) loadTasks(); }, 120000);
  </script>

  <!-- Google APIs last -->
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <!-- The GSI client provides BOTH oauth2 token client and One Tap ID client -->
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded(); gsiIdLoaded();"></script>
</body>
</html>
